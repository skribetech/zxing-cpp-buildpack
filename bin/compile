#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e
set -o pipefail

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

ZXING_VERSION="2.3.0"
ZXING_DIR="$CACHE_DIR/zxing-cpp-$ZXING_VERSION"
INSTALL_DIR="$BUILD_DIR/.zxing-cpp"

echo "-----> Installing zxing-cpp $ZXING_VERSION"

# Install build dependencies only if needed
if ! command -v cmake >/dev/null 2>&1 || ! command -v g++ >/dev/null 2>&1 || ! command -v git >/dev/null 2>&1; then
  echo "-----> Installing build dependencies"
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -qq 2>&1
  apt-get install -y -qq cmake g++ git 2>&1
else
  echo "-----> Build dependencies already present"
fi

# Check if we have a cached build
if [ -d "$ZXING_DIR" ]; then
  echo "-----> Using cached zxing-cpp source"
else
  echo "-----> Downloading zxing-cpp $ZXING_VERSION"
  mkdir -p "$CACHE_DIR"
  cd "$CACHE_DIR"

  # Download specific version
  git clone --depth 1 --branch v$ZXING_VERSION https://github.com/zxing-cpp/zxing-cpp.git "zxing-cpp-$ZXING_VERSION"
fi

# Build zxing-cpp
echo "-----> Building zxing-cpp"
cd "$ZXING_DIR"

# Create build directory
BUILD_OUTPUT_DIR="$ZXING_DIR/build"
rm -rf "$BUILD_OUTPUT_DIR"
mkdir -p "$BUILD_OUTPUT_DIR"

# Configure with CMake
echo "-----> Configuring with CMake"
cmake -S . -B "$BUILD_OUTPUT_DIR" \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX="$INSTALL_DIR" \
  -DBUILD_SHARED_LIBS=ON \
  -DBUILD_EXAMPLES=OFF \
  -DBUILD_BLACKBOX_TESTS=OFF

# Build
echo "-----> Compiling (this may take a few minutes)"
cmake --build "$BUILD_OUTPUT_DIR" -j$(nproc) --config Release

# Install to the app directory
echo "-----> Installing to app directory"
cmake --install "$BUILD_OUTPUT_DIR"

# Set up environment variables for runtime
echo "-----> Setting up environment"
mkdir -p "$BUILD_DIR/.profile.d"
cat > "$BUILD_DIR/.profile.d/zxing-cpp.sh" << EOF
export ZXING_CPP_HOME=\$HOME/.zxing-cpp
export LD_LIBRARY_PATH=\$ZXING_CPP_HOME/lib:\$LD_LIBRARY_PATH
export PKG_CONFIG_PATH=\$ZXING_CPP_HOME/lib/pkgconfig:\$PKG_CONFIG_PATH
export CMAKE_PREFIX_PATH=\$ZXING_CPP_HOME:\$CMAKE_PREFIX_PATH
EOF

echo "-----> zxing-cpp $ZXING_VERSION installed successfully"
