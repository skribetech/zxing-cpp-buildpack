#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e
set -o pipefail

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

ZXING_VERSION="2.3.0"
ZXING_COMMIT="d6068bcebeb8fd9f0d35a99b00d202be86a14dbe"
ZXING_DIR="$CACHE_DIR/zxing-cpp-$ZXING_COMMIT"
INSTALL_DIR="$BUILD_DIR/.zxing-cpp"

echo "-----> Installing zxing-cpp $ZXING_VERSION"

# Verify required build dependencies are available
echo "-----> Checking build dependencies"
MISSING_DEPS=""

if ! command -v cmake >/dev/null 2>&1; then
  MISSING_DEPS="$MISSING_DEPS cmake"
fi

if ! command -v g++ >/dev/null 2>&1; then
  MISSING_DEPS="$MISSING_DEPS g++"
fi

if ! command -v git >/dev/null 2>&1; then
  MISSING_DEPS="$MISSING_DEPS git"
fi

if [ -n "$MISSING_DEPS" ]; then
  echo "ERROR: Missing required build dependencies:$MISSING_DEPS"
  echo "These tools should be provided by your build environment/stack."
  echo "Please ensure you're using a stack that includes build-essential tools."
  exit 1
fi

echo "-----> Build dependencies present: cmake, g++, git"

# Check if we have a cached build
if [ -d "$ZXING_DIR" ]; then
  echo "-----> Using cached zxing-cpp source"
else
  echo "-----> Downloading zxing-cpp $ZXING_VERSION (commit $ZXING_COMMIT)"
  mkdir -p "$CACHE_DIR"
  cd "$CACHE_DIR"

  # Download specific version
  git clone --depth 1 --branch v$ZXING_VERSION https://github.com/zxing-cpp/zxing-cpp.git "zxing-cpp-$ZXING_COMMIT"

  # Verify we got the expected commit
  cd "zxing-cpp-$ZXING_COMMIT"
  ACTUAL_COMMIT=$(git rev-parse HEAD)
  if [ "$ACTUAL_COMMIT" != "$ZXING_COMMIT" ]; then
    echo "ERROR: Expected commit $ZXING_COMMIT but got $ACTUAL_COMMIT"
    echo "The v$ZXING_VERSION tag may have been moved. Buildpack needs to be updated."
    exit 1
  fi
  cd "$CACHE_DIR"
fi

# Build zxing-cpp
echo "-----> Building zxing-cpp"
cd "$ZXING_DIR"

# Create build directory
BUILD_OUTPUT_DIR="$ZXING_DIR/build"
rm -rf "$BUILD_OUTPUT_DIR"
mkdir -p "$BUILD_OUTPUT_DIR"

# Configure with CMake
echo "-----> Configuring with CMake"
cmake -S . -B "$BUILD_OUTPUT_DIR" \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX="$INSTALL_DIR" \
  -DBUILD_SHARED_LIBS=ON \
  -DZXING_EXAMPLES=OFF \
  -DZXING_WRITERS=OFF \
  -DZXING_USE_BUNDLED_ZINT=OFF

# Build
echo "-----> Compiling (this may take a few minutes)"
cmake --build "$BUILD_OUTPUT_DIR" -j$(nproc) --config Release

# Install to the app directory
echo "-----> Installing to app directory"
cmake --install "$BUILD_OUTPUT_DIR"

# Set up environment variables for runtime
echo "-----> Setting up environment"
mkdir -p "$BUILD_DIR/.profile.d"
cat > "$BUILD_DIR/.profile.d/zxing-cpp.sh" << EOF
export ZXING_CPP_HOME=\$HOME/.zxing-cpp
export LD_LIBRARY_PATH=\$ZXING_CPP_HOME/lib:\$LD_LIBRARY_PATH
export PKG_CONFIG_PATH=\$ZXING_CPP_HOME/lib/pkgconfig:\$PKG_CONFIG_PATH
export CMAKE_PREFIX_PATH=\$ZXING_CPP_HOME:\$CMAKE_PREFIX_PATH
EOF

# Export environment variables for subsequent buildpacks
echo "-----> Exporting build-time environment variables"
if [ -d "$ENV_DIR" ]; then
  echo "$INSTALL_DIR/lib/pkgconfig" > "$ENV_DIR/PKG_CONFIG_PATH"
  echo "$INSTALL_DIR/lib" > "$ENV_DIR/LD_LIBRARY_PATH"
  echo "$INSTALL_DIR" > "$ENV_DIR/CMAKE_PREFIX_PATH"
  echo "$INSTALL_DIR/include" > "$ENV_DIR/CPATH"
  echo "$INSTALL_DIR/lib" > "$ENV_DIR/LIBRARY_PATH"
fi

echo "-----> zxing-cpp $ZXING_VERSION installed successfully"
